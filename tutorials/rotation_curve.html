<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Plotting Rotation Cuves &mdash; pynbody 0.20-beta documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.20-beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="pynbody 0.20-beta documentation" href="../index.html" />
    <link rel="up" title="Pynbody Tutorials" href="tutorials.html" />
    <link rel="next" title="Pictures in Pynbody" href="pictures.html" />
    <link rel="prev" title="Profiles in Pynbody" href="profile.html" />
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38063425-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pictures.html" title="Pictures in Pynbody"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="profile.html" title="Profiles in Pynbody"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">pynbody 0.20-beta documentation</a> &raquo;</li>
          <li><a href="tutorials.html" accesskey="U">Pynbody Tutorials</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="plotting-rotation-cuves">
<h1>Plotting Rotation Cuves<a class="headerlink" href="#plotting-rotation-cuves" title="Permalink to this headline">Â¶</a></h1>
<p>Rotation curves are calculated and plotted using the <a class="reference internal" href="../analysis.html#pynbody.analysis.profile.Profile" title="pynbody.analysis.profile.Profile"><tt class="xref py py-func docutils literal"><span class="pre">Profile()</span></tt></a>
object. For a tutorial on profiles see <a class="reference internal" href="profile.html"><em>Profiles in Pynbody</em></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pynbody</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>
<span class="c"># load the snapshot and set to physical units</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;testdata/g15784.lr.01024.gz&#39;</span><span class="p">)</span>

<span class="c"># load the halos</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">halos</span><span class="p">()</span>

<span class="c"># center on the largest halo and align the disk</span>
<span class="n">pynbody</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">angmom</span><span class="o">.</span><span class="n">faceon</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c"># create a profile object for the stars</span>
<span class="n">s</span><span class="o">.</span><span class="n">physical_units</span><span class="p">()</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">Profile</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">min</span><span class="o">=.</span><span class="mo">01</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="n">ndim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">Profile</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="p">,</span><span class="nb">min</span><span class="o">=.</span><span class="mo">01</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="n">ndim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">Profile</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="nb">min</span><span class="o">=.</span><span class="mo">01</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="n">ndim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">pd</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">Profile</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="nb">min</span><span class="o">=.</span><span class="mo">01</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="n">ndim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c"># make the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;rbins&#39;</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;v_circ&#39;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;total&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pg</span><span class="p">[</span><span class="s">&#39;rbins&#39;</span><span class="p">],</span><span class="n">pg</span><span class="p">[</span><span class="s">&#39;v_circ&#39;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;gas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s">&#39;rbins&#39;</span><span class="p">],</span><span class="n">ps</span><span class="p">[</span><span class="s">&#39;v_circ&#39;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;stars&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="s">&#39;rbins&#39;</span><span class="p">],</span><span class="n">pd</span><span class="p">[</span><span class="s">&#39;v_circ&#39;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;dm&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;R [kpc]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&#39;$v_c$ [km/s]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../tutorials/example_code/rotcurve.py">Source code</a>, <a class="reference external" href="../tutorials/example_code/rotcurve.png">png</a>, <a class="reference external" href="../tutorials/example_code/rotcurve.hires.png">hires.png</a>, <a class="reference external" href="../tutorials/example_code/rotcurve.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/rotcurve.png" src="../_images/rotcurve.png" />
</div>
<div class="section" id="speeding-up-the-gravity-calculation-in-pynbody">
<h2>Speeding up the Gravity Calculation in Pynbody<a class="headerlink" href="#speeding-up-the-gravity-calculation-in-pynbody" title="Permalink to this headline">Â¶</a></h2>
<p>The rotation curve is calculated by calculating the forces in a
plane. The force calculation is a direct <img src="../_images/mathmpl/math-9d10ebcd52.png" style="position: relative; bottom: -3px"/> calculation, so
it takes a while and it is therefore done in <cite>C</cite>. It is even faster if
you use the parallel Open-MP version. This requires <cite>Cython</cite> and a
multi-core machine (which includes all modern computers...).</p>
<p>Check if you have <cite>Cython</cite> installed:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">cython</span>
</pre></div>
</div>
<p>If this doesn&#8217;t raise an error you&#8217;re good to go! If this fails,
you&#8217;ll need to <a class="reference external" href="http://cython.org/">install Cython</a> first.</p>
<p>Once you have <cite>Cython</cite>, the parallel version should be compiled and
installed automatically. Now, to use the parallel version in the
gravity calculation for the rotation curve, you need to make sure that
your pynbody options are set correctly. You can check the current
configuration like this:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [2]: </span><span class="kn">import</span> <span class="nn">pynbody</span>

<span class="gp">In [3]: </span><span class="n">pynbody</span><span class="o">.</span><span class="n">config</span>
<span class="go"> Out[3]: </span>
<span class="go">{&#39;centering-scheme&#39;: &#39;ssc&#39;,</span>
<span class="go"> &#39;default-cosmology&#39;: {&#39;a&#39;: 1.0,</span>
<span class="go">  &#39;h&#39;: 0.6777,</span>
<span class="go">  &#39;ns&#39;: 0.96,</span>
<span class="go">  &#39;omegaB0&#39;: 0.0482,</span>
<span class="go">  &#39;omegaL0&#39;: 0.691,</span>
<span class="go">  &#39;omegaM0&#39;: 0.309,</span>
<span class="go">  &#39;running&#39;: 0.0,</span>
<span class="go">  &#39;sigma8&#39;: 0.8288},</span>
<span class="go"> &#39;disk-fit-function&#39;: &#39;expsech&#39;,</span>
<span class="go"> &#39;gravity_calculation_mode&#39;: &#39;direct_omp&#39;,</span>
<span class="go"> &#39;halo-class-priority&#39;: [pynbody.halo.GrpCatalogue,</span>
<span class="go">  pynbody.halo.AmigaGrpCatalogue,</span>
<span class="go">  pynbody.halo.AHFCatalogue,</span>
<span class="go">  pynbody.halo.SubfindCatalogue],</span>
<span class="go"> &#39;number_of_threads&#39;: 4,</span>
<span class="go"> &#39;snap-class-priority&#39;: [pynbody.ramses.RamsesSnap,</span>
<span class="go">  pynbody.grafic.GrafICSnap,</span>
<span class="go">  pynbody.nchilada.NchiladaSnap,</span>
<span class="go">  pynbody.gadget.GadgetSnap,</span>
<span class="go">  pynbody.gadgethdf.GadgetHDFSnap,</span>
<span class="go">  pynbody.tipsy.TipsySnap],</span>
<span class="go"> &#39;sph&#39;: {&#39;smooth-particles&#39;: 64, &#39;tree-leafsize&#39;: 16},</span>
<span class="go"> &#39;threading&#39;: &#39;True&#39;,</span>
<span class="go"> &#39;tracktime&#39;: True,</span>
<span class="go"> &#39;verbose&#39;: True}</span>
</pre></div>
</div>
<p>Here we see two options: <tt class="docutils literal"><span class="pre">gravity_calculation_mode</span> <span class="pre">=</span> <span class="pre">'direct'</span></tt> and
<tt class="docutils literal"><span class="pre">number_of_threads</span> <span class="pre">=</span> <span class="pre">4</span></tt>. The second option tells pynbody to use 4
threads, but the first instructs it to use the serial version of the
gravity code. We can fix this, and if your machine has more cores you can tell it to use them:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [4]: </span><span class="n">pynbody</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;gravity_calculation_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;direct_omp&#39;</span>

<span class="gp">In [5]: </span><span class="n">pynbody</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;number_of_threads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>
</div>
<p>Now all gravity calculations will use the parallel gravity calculation
on 30 cpus. Note that the number of threads you specify in this option
will also be the default for other routines, such as
<a class="reference internal" href="../plot.html#pynbody.plot.sph.image" title="pynbody.plot.sph.image"><tt class="xref py py-func docutils literal"><span class="pre">pynbody.plot.sph.image()</span></tt></a>.</p>
<p>If you want to make your configuration changes permanent, create a file called <tt class="docutils literal"><span class="pre">.pynbodyrc</span></tt> in your home directory with the lines</p>
<div class="highlight-python"><div class="highlight"><pre>gravity_calculation_mode: direct_omp
number_of_threads: 30
</pre></div>
</div>
<p>See the file <tt class="docutils literal"><span class="pre">default_config.ini</span></tt> in the pynbody source distribution
for other options.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Plotting Rotation Cuves</a><ul>
<li><a class="reference internal" href="#speeding-up-the-gravity-calculation-in-pynbody">Speeding up the Gravity Calculation in Pynbody</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="profile.html"
                        title="previous chapter">Profiles in Pynbody</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pictures.html"
                        title="next chapter">Pictures in Pynbody</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/tutorials/rotation_curve.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pictures.html" title="Pictures in Pynbody"
             >next</a> |</li>
        <li class="right" >
          <a href="profile.html" title="Profiles in Pynbody"
             >previous</a> |</li>
        <li><a href="../index.html">pynbody 0.20-beta documentation</a> &raquo;</li>
          <li><a href="tutorials.html" >Pynbody Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011-14, pynbody team https://github.com/pynbody/pynbody/graphs/contributors.
<<<<<<< HEAD
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
=======
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
>>>>>>> a2ea4e4a5c33a4434c23e6765841db65159e9697
    </div>
  </body>
</html>