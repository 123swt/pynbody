<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pynbody.plot.sph &mdash; pynbody 0.42 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootswatch-3.1.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.42',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="pynbody 0.42 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38063425-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          pynbody</a>
        <span class="navbar-text navbar-version pull-left"><b>0.42</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Sections <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials &amp; walkthroughs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <h1>Source code for pynbody.plot.sph</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">sph</span>
<span class="sd">===</span>

<span class="sd">routines for plotting smoothed quantities</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">p</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">sph</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">_units</span>


<div class="viewcode-block" id="sideon_image"><a class="viewcode-back" href="../../../reference/plot.html#pynbody.plot.sph.sideon_image">[docs]</a><span class="k">def</span> <span class="nf">sideon_image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Rotate the simulation so that the disc of the passed halo is</span>
<span class="sd">    side-on, then make an SPH image by passing the parameters into</span>
<span class="sd">    the function image</span>

<span class="sd">    For a description of keyword arguments see :func:`~pynbody.plot.sph.image`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">..analysis</span> <span class="kn">import</span> <span class="n">angmom</span>

    <span class="k">with</span> <span class="n">angmom</span><span class="o">.</span><span class="n">sideon</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="faceon_image"><a class="viewcode-back" href="../../../reference/plot.html#pynbody.plot.sph.faceon_image">[docs]</a><span class="k">def</span> <span class="nf">faceon_image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Rotate the simulation so that the disc of the passed halo is</span>
<span class="sd">    face-on, then make an SPH image by passing the parameters into</span>
<span class="sd">    the function image</span>

<span class="sd">    For a description of keyword arguments see :func:`~pynbody.plot.sph.image`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">..analysis</span> <span class="kn">import</span> <span class="n">angmom</span>

    <span class="k">with</span> <span class="n">angmom</span><span class="o">.</span><span class="n">faceon</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="velocity_image"><a class="viewcode-back" href="../../../reference/plot.html#pynbody.plot.sph.velocity_image">[docs]</a><span class="k">def</span> <span class="nf">velocity_image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s">&quot;10 kpc&quot;</span><span class="p">,</span> <span class="n">vector_color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">quiverkey_bg_color</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">vector_resolution</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;quiver&#39;</span><span class="p">,</span> <span class="n">key_x</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">key_y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                   <span class="n">key_color</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">key_length</span><span class="o">=</span><span class="s">&quot;100 km s**-1&quot;</span><span class="p">,</span> <span class="n">quiverkey</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                   <span class="n">vector_qty</span><span class="o">=</span><span class="s">&#39;vel&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Make an SPH image of the given simulation with velocity vectors overlaid on top.</span>

<span class="sd">    For a description of additional keyword arguments see :func:`~pynbody.plot.sph.image`,</span>
<span class="sd">    or see the `tutorial &lt;http://pynbody.github.io/pynbody/tutorials/pictures.html#velocity-vectors&gt;`_.</span>

<span class="sd">    **Keyword arguments:**</span>

<span class="sd">    *vector_color* (black): The color for the velocity vectors</span>

<span class="sd">    *edgecolor* (black): edge color used for the lines - using a color</span>
<span class="sd">     other than black for the *vector_color* and a black *edgecolor*</span>
<span class="sd">     can result in poor readability in pdfs</span>

<span class="sd">    *vector_resolution* (40): How many vectors in each dimension (default is 40x40)</span>

<span class="sd">    *quiverkey_bg_color* (none): The color for the legend (scale) background</span>

<span class="sd">    *scale* (None): The length of a vector that would result in a displayed length of the</span>
<span class="sd">    figure width/height.</span>

<span class="sd">    *mode* (&#39;quiver&#39;): make a &#39;quiver&#39; or &#39;stream&#39; plot</span>

<span class="sd">    *key_x* (0.3): Display x (width) position for the vector key (quiver mode only)</span>

<span class="sd">    *key_y* (0.9): Display y (height) position for the vector key (quiver mode only)</span>

<span class="sd">    *key_color* (white): Color for the vector key (quiver mode only)</span>

<span class="sd">    *key_length* (100 km/s): Velocity to use for the vector key (quiver mode only)</span>

<span class="sd">    *density* (1.0): Density of stream lines (stream mode only)</span>

<span class="sd">    *quiverkey* (True): Whether or not to inset the key</span>

<span class="sd">    *vector_qty* (&#39;vel&#39;): The name of the vector field to plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subplot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subplot&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">av_z</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;av_z&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subplot</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subplot</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">p</span>

    <span class="n">vx_name</span><span class="p">,</span> <span class="n">vy_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_array_name_ND_to_1D</span><span class="p">(</span><span class="n">vector_qty</span><span class="p">)</span>

    <span class="n">vx</span> <span class="o">=</span> <span class="n">image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">vx_name</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">resolution</span><span class="o">=</span><span class="n">vector_resolution</span><span class="p">,</span> <span class="n">noplot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">av_z</span><span class="o">=</span><span class="n">av_z</span><span class="p">)</span>
    <span class="n">vy</span> <span class="o">=</span> <span class="n">image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">vy_name</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">resolution</span><span class="o">=</span><span class="n">vector_resolution</span><span class="p">,</span> <span class="n">noplot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">av_z</span><span class="o">=</span><span class="n">av_z</span><span class="p">)</span>
    <span class="n">key_unit</span> <span class="o">=</span> <span class="n">_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">key_length</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">width</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">_units</span><span class="o">.</span><span class="n">UnitBase</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">sim</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">())</span>

    <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

    <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">vector_resolution</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pixel_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pixel_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pixel_size</span> <span class="p">),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pixel_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pixel_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">))</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;quiver&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">vector_color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span>
                <span class="n">sim</span><span class="p">[</span><span class="s">&#39;vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">vector_color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quiverkey</span><span class="p">:</span>
        	<span class="n">qk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">quiverkey</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">key_x</span><span class="p">,</span> <span class="n">key_y</span><span class="p">,</span> <span class="n">key_unit</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">sim</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">()),</span>
                    <span class="s">r&quot;$\mathbf{&quot;</span> <span class="o">+</span> <span class="n">key_unit</span><span class="o">.</span><span class="n">latex</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;}$&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">key_color</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">key_color</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
        <span class="k">if</span>  <span class="n">quiverkey_bg_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">qk</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">set_backgroundcolor</span><span class="p">(</span><span class="n">quiverkey_bg_color</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;stream&#39;</span> <span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">streamplot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">vector_color</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">)</span>

	<span class="c"># RS - if a axis object is passed in, use the right limit call</span>
    <span class="k">if</span> <span class="n">subplot</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im</span>

</div>
<div class="viewcode-block" id="volume"><a class="viewcode-back" href="../../../reference/plot.html#pynbody.plot.sph.volume">[docs]</a><span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span><span class="n">vmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">dynamic_range</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
           <span class="n">create_figure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a volume rendering of the given simulation using mayavi.</span>

<span class="sd">    **Keyword arguments:**</span>

<span class="sd">    *qty* (rho): The name of the array to interpolate</span>

<span class="sd">    *width* (None): The width of the cube to generate, centered on the origin</span>

<span class="sd">    *resolution* (200): The number of elements along each side of the cube</span>

<span class="sd">    *color* (white): The color of the volume rendering. The value of each voxel</span>
<span class="sd">       is used to set the opacity.</span>

<span class="sd">    *vmin* (None): The value for zero opacity (calculated using dynamic_range if None)</span>

<span class="sd">    *vmax* (None): The value for full opacity (calculated from the maximum</span>
<span class="sd">       value in the region if None)</span>

<span class="sd">    *dynamic_range*: The dynamic range to use if vmin and vmax are not specified</span>

<span class="sd">    *log* (True): log-scale the image before passing to mayavi</span>

<span class="sd">    *create_figure* (True): create a new mayavi figure before rendering</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">mayavi</span>
    <span class="kn">from</span> <span class="nn">mayavi</span> <span class="kn">import</span> <span class="n">mlab</span>
    <span class="kn">from</span> <span class="nn">tvtk.util.ctf</span> <span class="kn">import</span> <span class="n">PiecewiseFunction</span><span class="p">,</span> <span class="n">ColorTransferFunction</span>



    <span class="k">if</span> <span class="n">create_figure</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">),</span><span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">grid_data</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">to_3d_grid</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span><span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                               <span class="n">x2</span><span class="o">=</span><span class="bp">None</span> <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>



    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">grid_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">grid_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">grid_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">dynamic_range</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">grid_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">grid_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grid_data</span><span class="p">)</span>

    <span class="n">grid_data</span><span class="p">[</span><span class="n">grid_data</span><span class="o">&lt;</span><span class="n">vmin</span><span class="p">]</span><span class="o">=</span><span class="n">vmin</span>
    <span class="n">grid_data</span><span class="p">[</span><span class="n">grid_data</span><span class="o">&gt;</span><span class="n">vmax</span><span class="p">]</span><span class="o">=</span><span class="n">vmax</span>

    <span class="n">otf</span> <span class="o">=</span> <span class="n">PiecewiseFunction</span><span class="p">()</span>
    <span class="n">otf</span><span class="o">.</span><span class="n">add_point</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">otf</span><span class="o">.</span><span class="n">add_point</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">sf</span> <span class="o">=</span> <span class="n">mayavi</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">scalar_field</span><span class="p">(</span><span class="n">grid_data</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>




    <span class="n">V</span><span class="o">.</span><span class="n">trait_get</span><span class="p">(</span><span class="s">&#39;volume_mapper&#39;</span><span class="p">)[</span><span class="s">&#39;volume_mapper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">blend_mode</span> <span class="o">=</span> <span class="s">&#39;maximum_intensity&#39;</span>

    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ctf</span> <span class="o">=</span> <span class="n">ColorTransferFunction</span><span class="p">()</span>
        <span class="n">ctf</span><span class="o">.</span><span class="n">add_rgb_point</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span><span class="mf">107.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mf">124.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mf">132.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>
        <span class="n">ctf</span><span class="o">.</span><span class="n">add_rgb_point</span><span class="p">(</span><span class="n">vmin</span><span class="o">+</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">200.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mf">178.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mf">164.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>
        <span class="n">ctf</span><span class="o">.</span><span class="n">add_rgb_point</span><span class="p">(</span><span class="n">vmin</span><span class="o">+</span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">210.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mf">149.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>
        <span class="n">ctf</span><span class="o">.</span><span class="n">add_rgb_point</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">222.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mf">141.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>

        <span class="n">V</span><span class="o">.</span><span class="n">_volume_property</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">ctf</span><span class="p">)</span>
        <span class="n">V</span><span class="o">.</span><span class="n">_ctf</span> <span class="o">=</span> <span class="n">ctf</span>
        <span class="n">V</span><span class="o">.</span><span class="n">update_ctf</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">V</span><span class="o">.</span><span class="n">_otf</span> <span class="o">=</span> <span class="n">otf</span>
    <span class="n">V</span><span class="o">.</span><span class="n">_volume_property</span><span class="o">.</span><span class="n">set_scalar_opacity</span><span class="p">(</span><span class="n">otf</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">V</span>
</div>
<div class="viewcode-block" id="contour"><a class="viewcode-back" href="../../../reference/plot.html#pynbody.plot.sph.contour">[docs]</a><span class="k">def</span> <span class="nf">contour</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make an SPH image of the given simulation and render it as contours.</span>
<span class="sd">    nlevels and levels are passed to pyplot&#39;s contour command.</span>

<span class="sd">    Other arguments are as for *image*.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="n">kwargs_image</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">nlevels</span> <span class="o">=</span> <span class="n">kwargs_image</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;nlevels&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="n">kwargs_image</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;levels&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">kwargs_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">,</span><span class="s">&#39;10 kpc&#39;</span><span class="p">)</span>
    <span class="n">kwargs_image</span><span class="p">[</span><span class="s">&#39;noplot&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">image</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_image</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">units</span> <span class="o">=</span> <span class="n">kwargs_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;units&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">width</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">_units</span><span class="o">.</span><span class="n">UnitBase</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">sim</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">())</span>

    <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">p</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">im</span><span class="p">,</span><span class="n">nlevels</span><span class="o">=</span><span class="n">nlevels</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_units_imply_projection</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sim</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">sim</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">())</span>
        <span class="c"># if this fails, perhaps we&#39;re requesting a projected image?</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="n">_units</span><span class="o">.</span><span class="n">UnitsException</span><span class="p">:</span>
        <span class="c"># if the following fails, there&#39;s no interpretation this routine</span>
        <span class="c"># can cope with. The error will be allowed to propagate.</span>
        <span class="n">sim</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span>
            <span class="n">units</span> <span class="o">/</span> <span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">),</span> <span class="o">**</span><span class="n">sim</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">True</span>


<div class="viewcode-block" id="image"><a class="viewcode-back" href="../../../reference/plot.html#pynbody.plot.sph.image">[docs]</a><span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s">&quot;10 kpc&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
          <span class="n">vmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">av_z</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
          <span class="n">z_camera</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
          <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qtytitle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show_cbar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
          <span class="n">noplot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ret_im</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fill_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Make an SPH image of the given simulation.</span>

<span class="sd">    **Keyword arguments:**</span>

<span class="sd">    *qty* (rho): The name of the array to interpolate</span>

<span class="sd">    *width* (10 kpc): The overall width and height of the plot. If</span>
<span class="sd">     ``width`` is a float or an int, then it is assumed to be in units</span>
<span class="sd">     of ``sim[&#39;pos&#39;]``. It can also be passed in as a string</span>
<span class="sd">     indicating the units, i.e. &#39;10 kpc&#39;, in which case it is</span>
<span class="sd">     converted to units of ``sim[&#39;pos&#39;]``.</span>

<span class="sd">    *resolution* (500): The number of pixels wide and tall</span>

<span class="sd">    *units* (None): The units of the output</span>

<span class="sd">    *av_z* (False): If True, the requested quantity is averaged down</span>
<span class="sd">            the line of sight (default False: image is generated in</span>
<span class="sd">            the thin plane z=0, unless output units imply an integral</span>
<span class="sd">            down the line of sight). If a string, the requested quantity</span>
<span class="sd">            is averaged down the line of sight weighted by the av_z</span>
<span class="sd">            array (e.g. use &#39;rho&#39; for density-weighted quantity;</span>
<span class="sd">            the default results when av_z=True are volume-weighted).</span>

<span class="sd">    *z_camera* (None): If set, a perspective image is rendered. See</span>
<span class="sd">                :func:`pynbody.sph.image` for more details.</span>

<span class="sd">    *filename* (None): if set, the image will be saved in a file</span>

<span class="sd">    *clear* (True): whether to call clf() on the axes first</span>

<span class="sd">    *cmap* (None): user-supplied colormap instance</span>

<span class="sd">    *title* (None): plot title</span>

<span class="sd">    *qtytitle* (None): colorbar quantity title</span>

<span class="sd">    *show_cbar* (True): whether to plot the colorbar</span>

<span class="sd">    *subplot* (False): the user can supply a AxesSubPlot instance on</span>
<span class="sd">    which the image will be shown</span>

<span class="sd">    *noplot* (False): do not display the image, just return the image array</span>

<span class="sd">    *ret_im* (False): return the image instance returned by imshow</span>

<span class="sd">    *num_threads* (None) : if set, specify the number of threads for</span>
<span class="sd">    the multi-threaded routines; otherwise the pynbody.config default is used</span>

<span class="sd">    *fill_nan* (True): if any of the image values are NaN, replace with fill_val</span>

<span class="sd">    *fill_val* (0.0): the fill value to use when replacing NaNs</span>

<span class="sd">    *linthresh* (None): if the image has negative and positive values</span>
<span class="sd">     and a log scaling is requested, the part between `-linthresh` and</span>
<span class="sd">     `linthresh` is shown on a linear scale to avoid divergence at 0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">noplot</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="k">global</span> <span class="n">config</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">noplot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subplot</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subplot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span>

    <span class="k">if</span> <span class="n">qtytitle</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">qtytitle</span> <span class="o">=</span> <span class="n">qty</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">width</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">_units</span><span class="o">.</span><span class="n">UnitBase</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">_units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">sim</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">())</span>

    <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">Kernel</span><span class="p">()</span>

    <span class="n">perspective</span> <span class="o">=</span> <span class="n">z_camera</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">perspective</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">av_z</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">Kernel2D</span><span class="p">()</span>

    <span class="n">is_projected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">is_projected</span> <span class="o">=</span> <span class="n">_units_imply_projection</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_projected</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">Kernel2D</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">av_z</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">sph</span><span class="o">.</span><span class="n">Kernel2D</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">_units</span><span class="o">.</span><span class="n">UnitsException</span><span class="p">(</span>
                <span class="s">&quot;Units already imply projected image; can&#39;t also average over line-of-sight!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">Kernel2D</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">aunits</span> <span class="o">=</span> <span class="n">units</span> <span class="o">*</span> <span class="n">sim</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aunits</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">av_z</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">aunits</span> <span class="o">=</span> <span class="n">units</span> <span class="o">*</span> <span class="n">sim</span><span class="p">[</span><span class="n">av_z</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">*</span> <span class="n">sim</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
                <span class="n">sim</span><span class="p">[</span><span class="s">&quot;__prod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="n">av_z</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span>
                <span class="n">qty</span> <span class="o">=</span> <span class="s">&quot;__prod&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">av_z</span> <span class="o">=</span> <span class="s">&quot;__one&quot;</span>
                <span class="n">sim</span><span class="p">[</span><span class="s">&quot;__one&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="n">qty</span><span class="p">])</span>
                <span class="n">sim</span><span class="p">[</span><span class="s">&quot;__one&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s">&quot;1&quot;</span>

            <span class="n">im</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">render_image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">out_units</span><span class="o">=</span><span class="n">aunits</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
                                  <span class="n">z_camera</span><span class="o">=</span><span class="n">z_camera</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">im2</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">render_image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">av_z</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
                                   <span class="n">z_camera</span><span class="o">=</span><span class="n">z_camera</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">top</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">ancestor</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">top</span><span class="p">[</span><span class="s">&quot;__one&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">top</span><span class="p">[</span><span class="s">&quot;__prod&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span> <span class="o">/</span> <span class="n">im2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">sph</span><span class="o">.</span><span class="n">render_image</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">out_units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                              <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>  <span class="n">z_camera</span><span class="o">=</span><span class="n">z_camera</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fill_nan</span><span class="p">:</span>
        <span class="n">im</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">im</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fill_val</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">noplot</span><span class="p">:</span>

        <span class="c"># set the log or linear normalizations</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">im</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">im</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;Failed to make a sensible logarithmic image. This probably means there are no particles in the view.&quot;</span>

            <span class="c"># check if there are negative values -- if so, use the symmetric</span>
            <span class="c"># log normalization</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">vmin</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">im</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">vmin</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>

                <span class="c"># need to set the linear regime around zero -- set to by</span>
                <span class="c"># default start at 1/1000 of the log range</span>
                <span class="k">if</span> <span class="n">linthresh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">linthresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">im</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1000.</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span>
                    <span class="n">linthresh</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

        <span class="c">#</span>
        <span class="c"># do the actual plotting</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="n">clear</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">subplot</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ret_im</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">)</span>

        <span class="n">ims</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">)</span>

        <span class="n">u_st</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">latex</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subplot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;$x/</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">u_st</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;$y/</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">u_st</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;$x/</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">u_st</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;$y/</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">u_st</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">units</span>


        
        <span class="k">if</span> <span class="n">units</span><span class="o">.</span><span class="n">latex</span><span class="p">()</span> <span class="ow">is</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s">&quot;$&quot;</span><span class="o">+</span><span class="n">units</span><span class="o">.</span><span class="n">latex</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;$&quot;</span>

        <span class="k">if</span> <span class="n">show_cbar</span><span class="p">:</span>
             <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ims</span><span class="p">)</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">qtytitle</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">units</span><span class="p">)</span>

        <span class="c"># colorbar doesn&#39;t work wtih subplot:  mappable is NoneType</span>
        <span class="c"># elif show_cbar:</span>
        <span class="c">#    import matplotlib.pyplot as mpl</span>
        <span class="c">#    if qtytitle: mpl.colorbar().set_label(qtytitle)</span>
        <span class="c">#    else:        mpl.colorbar().set_label(units)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">subplot</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="c"># plt.show() - removed by AP on 30/01/2013 - this should not be here as</span>
        <span class="c"># for some systems you don&#39;t get back to the command prompt</span>

    <span class="k">return</span> <span class="n">im</span>

</div>
<span class="k">def</span> <span class="nf">image_radial_profile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

    <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">xsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">ysize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ysize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xs</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ys</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">ave_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bin_edges</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">max_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bin_edges</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">min_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bin_edges</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bin_edges</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inds</span> <span class="o">==</span> <span class="n">i</span><span class="p">)]))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">min_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;nan&#39;</span><span class="p">)</span>
        <span class="n">ave_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inds</span> <span class="o">==</span> <span class="n">i</span><span class="p">)]))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inds</span> <span class="o">==</span> <span class="n">i</span><span class="p">)]))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">max_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;nan&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ave_vals</span><span class="p">,</span> <span class="n">min_vals</span><span class="p">,</span> <span class="n">max_vals</span><span class="p">,</span> <span class="n">bin_edges</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2011-18, pynbody team.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>