
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pynbody.tipsy &mdash; pynbody v0.13-alpha documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.13-alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="pynbody v0.13-alpha documentation" href="../../index.html" />
    <link rel="up" title="pynbody" href="../pynbody.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pynbody v0.13-alpha documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pynbody.html" accesskey="U">pynbody</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pynbody.tipsy</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">family</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">config_parser</span>

<span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">class</span> <span class="nc">TipsySnap</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">SimSnap</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">only_header</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">must_have_paramfile</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="p">:</span>

        <span class="k">global</span> <span class="n">config</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TipsySnap</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">cutgz</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
	
        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;TipsySnap: loading &quot;</span><span class="p">,</span><span class="n">filename</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;diiiii&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="o">=</span><span class="bp">True</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;diiiii&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="o">=</span><span class="bp">False</span>
            
        <span class="c"># In non-cosmological simulations, what is t? Is it physical</span>
        <span class="c"># time?  In which case, we need some way of telling what we</span>
        <span class="c"># are dealing with and setting properties accordingly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">t</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            
	<span class="k">assert</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">3</span>
	
	<span class="bp">self</span><span class="o">.</span><span class="n">_num_particles</span> <span class="o">=</span> <span class="n">ng</span><span class="o">+</span><span class="n">nd</span><span class="o">+</span><span class="n">ns</span>
	<span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

	<span class="c"># Store slices corresponding to different particle types</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_family_slice</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ng</span><span class="p">)</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_family_slice</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="o">+</span><span class="n">ng</span><span class="p">)</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_family_slice</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">nd</span><span class="o">+</span><span class="n">ng</span><span class="p">,</span> <span class="n">ng</span><span class="o">+</span><span class="n">nd</span><span class="o">+</span><span class="n">ns</span><span class="p">)</span>

	<span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;pos&quot;</span><span class="p">,</span><span class="s">&quot;vel&quot;</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">])</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;rho&quot;</span><span class="p">,</span><span class="s">&quot;temp&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">])</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;tform&quot;</span><span class="p">])</span>

	<span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">[</span><span class="s">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s">&quot;K&quot;</span> <span class="c"># we know the temperature is always in K</span>
	<span class="c"># Other units will be set by the decorators later</span>
	

	<span class="c"># Load in the tipsy file in blocks.  This is the most</span>
	<span class="c"># efficient balance I can see for keeping IO contiguuous, not</span>
	<span class="c"># wasting memory, but also not having too much python &lt;-&gt; C</span>
	<span class="c"># interface overheads</span>

	<span class="n">max_block_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="c"># particles</span>

	<span class="c"># describe the file structure as list of (num_parts, [list_of_properties]) </span>
	<span class="n">file_structure</span> <span class="o">=</span> <span class="p">((</span><span class="n">ng</span><span class="p">,</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;rho&quot;</span><span class="p">,</span><span class="s">&quot;temp&quot;</span><span class="p">,</span><span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">]),</span>
			  <span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">]),</span>
			  <span class="p">(</span><span class="n">ns</span><span class="p">,</span><span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">,[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;tform&quot;</span><span class="p">,</span><span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">]))</span>
	
	<span class="bp">self</span><span class="o">.</span><span class="n">_decorate</span><span class="p">()</span>

        <span class="k">if</span>  <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;achOutName&#39;</span><span class="p">))</span> <span class="p">:</span>
	    <span class="k">if</span> <span class="n">must_have_paramfile</span> <span class="p">:</span>
		<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s">&quot;Could not find .param file for this run. Place it in the run&#39;s directory or parent directory.&quot;</span>
	    <span class="k">else</span> <span class="p">:</span>
		<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No readable param file in the run directory or parent directory: using defaults.&quot;</span><span class="p">,</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
	    
        <span class="n">time_unit</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_original_units</span><span class="p">(</span><span class="s">&#39;yr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">units</span><span class="o">.</span><span class="n">UnitsException</span> <span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;bComove&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&#39;bComove&#39;</span><span class="p">])</span><span class="o">!=</span><span class="mi">0</span> <span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">analysis</span>
            <span class="kn">import</span> <span class="nn">analysis.cosmology</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">t</span> <span class="o">-</span> <span class="mf">1.0</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span> <span class="p">:</span>
                <span class="c"># no sensible redshift</span>
                <span class="k">pass</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;dMsolUnit&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;dKpcUnit&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">analysis</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="c"># something has gone wrong with the cosmological side of</span>
                <span class="c"># things</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Paramfile suggests time is cosmological, but header values are not sensible in this context.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            
        <span class="k">else</span> <span class="p">:</span>
            <span class="c"># Assume a non-cosmological run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">t</span>
            
        <span class="k">if</span> <span class="n">time_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span><span class="o">*=</span><span class="n">time_unit</span>

        <span class="k">if</span> <span class="n">only_header</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span>
	
	<span class="k">for</span> <span class="n">n_left</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">file_structure</span> <span class="p">:</span>
	    <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
	    <span class="n">self_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
	    <span class="k">while</span> <span class="n">n_left</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
                <span class="n">n_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_left</span><span class="p">,</span><span class="n">max_block_size</span><span class="p">)</span>

				
                <span class="c"># Read in the block</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">):</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">*</span><span class="n">n_block</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span><span class="s">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_block</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
		    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">*</span><span class="n">n_block</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span><span class="s">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_block</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)))</span>
	
                    
		<span class="c"># Copy into the correct arrays</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">:</span>
		    <span class="n">self_type</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">n_done</span><span class="p">:</span><span class="n">n_done</span><span class="o">+</span><span class="n">n_block</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>

		<span class="c"># Increment total ptcls read in, decrement ptcls left of this type</span>
		<span class="n">n_left</span><span class="o">-=</span><span class="n">n_block</span>
		<span class="n">n_done</span><span class="o">+=</span><span class="n">n_block</span>


	

    <span class="k">def</span> <span class="nf">loadable_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Produce and return a list of loadable arrays for this TIPSY file.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_readable_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="p">:</span>
                <span class="c"># could be a binary file</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s">&#39;fileobj&#39;</span><span class="p">)</span> <span class="p">:</span>
                    <span class="c"># Cludge to get un-zipped length</span>
                    <span class="n">fx</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fileobj</span>
                    <span class="n">fx</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">buflen</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">read32</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span>
                    <span class="n">ourlen_1</span> <span class="o">=</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="n">L</span>
                    <span class="n">ourlen_3</span> <span class="o">=</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="n">L</span>
                    
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">buflen</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">ourlen_1</span> <span class="o">=</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">ourlen_3</span> <span class="o">=</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">buflen</span><span class="o">==</span><span class="n">ourlen_1</span> <span class="p">:</span> <span class="c"># it&#39;s a vector</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">buflen</span><span class="o">==</span><span class="n">ourlen_3</span> <span class="p">:</span> <span class="c"># it&#39;s an array</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                
            <span class="k">except</span> <span class="ne">IOError</span> <span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loadable_keys_registry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">cutgz</span><span class="p">,</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">+</span><span class="s">&quot;.*&quot;</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span>  <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">q</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> 
                       <span class="nb">filter</span><span class="p">(</span><span class="n">is_readable_array</span><span class="p">,</span> <span class="n">fs</span><span class="p">))</span>
           
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_loadable_keys_registry</span> <span class="o">=</span> <span class="n">res</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadable_keys_registry</span>

    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write a TIPSY file.  Just the reverse of reading a file. &quot;&quot;&quot;</span>

	<span class="k">global</span> <span class="n">config</span>
	
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_off</span> <span class="p">:</span> <span class="c"># prevent any lazy reading or evaluation</span>
	    
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
                <span class="c">#if self._filename[-3:] == &#39;.gz&#39; :</span>
                <span class="c">#    filename = self._filename[:-3]+&quot;.new.gz&quot;</span>
                <span class="c">#else :</span>
                <span class="c">#    filename = self._filename+&#39;.new&#39;</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
		
	    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;TipsySnap: writing main file as&quot;</span><span class="p">,</span><span class="n">filename</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
	    <span class="k">try</span><span class="p">:</span>
		<span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span>
	    <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
		<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Time is unknown: writing zero in header&quot;</span><span class="p">,</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
		
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">ng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">)</span>
            <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">)</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">)</span>

	    
	    <span class="n">byteswap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_byteswap&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	    
	    <span class="k">if</span> <span class="n">byteswap</span><span class="p">:</span> 
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;diiiiii&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ndim</span><span class="p">,</span><span class="n">ng</span><span class="p">,</span><span class="n">nd</span><span class="p">,</span><span class="n">ns</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;diiiiii&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ndim</span><span class="p">,</span><span class="n">ng</span><span class="p">,</span><span class="n">nd</span><span class="p">,</span><span class="n">ns</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
            <span class="c"># needs to be done in blocks like reading</span>
            <span class="c"># describe the file structure as list of (num_parts, [list_of_properties]) </span>
            <span class="n">file_structure</span> <span class="o">=</span> <span class="p">((</span><span class="n">ng</span><span class="p">,</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;rho&quot;</span><span class="p">,</span><span class="s">&quot;temp&quot;</span><span class="p">,</span><span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">]),</span>
                              <span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">]),</span>
                              <span class="p">(</span><span class="n">ns</span><span class="p">,</span><span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">,[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;tform&quot;</span><span class="p">,</span><span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">]))</span>
            <span class="n">max_block_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="c"># particles</span>
            <span class="k">for</span> <span class="n">n_left</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">file_structure</span> <span class="p">:</span>
                <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">self_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">n_left</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
                    <span class="n">n_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_left</span><span class="p">,</span><span class="n">max_block_size</span><span class="p">)</span>                   
		    
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_block</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                    <span class="c"># Copy from the correct arrays</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
			    <span class="n">g</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">self_type</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">n_done</span><span class="p">:</span><span class="n">n_done</span><span class="o">+</span><span class="n">n_block</span><span class="p">])</span>
			<span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
			    <span class="k">pass</span>
			
                    <span class="c"># Write out the block</span>
		    <span class="k">if</span> <span class="n">byteswap</span> <span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                    <span class="c"># Increment total ptcls written, decrement ptcls left of this type</span>
                    <span class="n">n_left</span><span class="o">-=</span><span class="n">n_block</span>
                    <span class="n">n_done</span><span class="o">+=</span><span class="n">n_block</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;TipsySnap: writing auxiliary arrays&quot;</span>

	    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family_keys</span><span class="p">())</span> <span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_derived_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;pos&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vel&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;rho&quot;</span><span class="p">,</span><span class="s">&quot;temp&quot;</span><span class="p">,</span>
							      <span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">,</span> <span class="s">&quot;tform&quot;</span><span class="p">]</span>  <span class="p">:</span>
		    <span class="n">TipsySnap</span><span class="o">.</span><span class="n">_write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
		    

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__write_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">ar</span><span class="p">,</span><span class="n">binary</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">binary</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">byteswap</span><span class="p">:</span>
                <span class="n">ar</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">ar</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">ar</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="nb">float</span> <span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%g</span><span class="s">&quot;</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">byteswap</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write a TIPSY-ASCII file.&quot;&quot;&quot;</span>

        
            

        <span class="k">if</span> <span class="n">binary</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">,</span><span class="s">&quot;_tipsy_arrays_binary&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">binary</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">byteswap</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">byteswap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">,</span> <span class="s">&quot;_byteswap&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;mass&quot;</span><span class="p">,</span><span class="s">&quot;pos&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vel&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;rho&quot;</span><span class="p">,</span><span class="s">&quot;temp&quot;</span><span class="p">,</span>
			  <span class="s">&quot;eps&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;phi&quot;</span><span class="p">]</span> <span class="p">:</span>
	    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s">&quot;Cannot write back into TIPSY file.&quot;</span> 

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_off</span> <span class="p">:</span> <span class="c"># prevent any lazy reading or evaluation</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;.gz&#39;</span> <span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">array_name</span><span class="o">+</span><span class="s">&quot;.gz&quot;</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">array_name</span>
            <span class="k">if</span> <span class="n">binary</span> <span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">byteswap</span> <span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
    
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

            <span class="k">else</span> <span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        

            <span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">family_keys</span><span class="p">()</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">fam</span> <span class="ow">in</span> <span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]</span> <span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ar</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
                        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    
                    <span class="n">TipsySnap</span><span class="o">.</span><span class="n">__write_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">)</span>
                    
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">ar</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span>
                <span class="n">TipsySnap</span><span class="o">.</span><span class="n">__write_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_load_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">packed_vector</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read a TIPSY-ASCII or TIPSY-BINARY auxiliary file with the</span>
<span class="sd">        specified name. If fam is not None, read only the particles of</span>
<span class="sd">        the specified family.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;massform&#39;</span><span class="p">,</span> <span class="s">&#39;rhoform&#39;</span><span class="p">,</span> <span class="s">&#39;tempform&#39;</span><span class="p">,</span><span class="s">&#39;phiform&#39;</span><span class="p">,</span><span class="s">&#39;nsmooth&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_starlog</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
	
	<span class="c"># N.B. this code is a bit inefficient for loading</span>
	<span class="c"># family-specific arrays, because it reads in the whole array</span>
	<span class="c"># then slices it.  But of course the memory is only wasted</span>
	<span class="c"># while still inside this routine, so it&#39;s only really the</span>
	<span class="c"># wasted time that&#39;s a problem.</span>
	
        <span class="c"># determine whether the array exists in a file</span>
        
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;.gz&#39;</span> <span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">array_name</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">array_name</span>
                
        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;TipsySnap: attempting to load auxiliary array&quot;</span><span class="p">,</span><span class="n">filename</span>
        <span class="c"># if we get here, we&#39;ve got the file - try loading it</span>
  
	<span class="k">try</span> <span class="p">:</span>
	    <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">,</span> <span class="s">&quot;Incorrect file format&quot;</span>
	
            <span class="c"># Inspect the first line to see whether it&#39;s float or int</span>
            <span class="n">l</span> <span class="o">=</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="k">while</span> <span class="n">l</span><span class="o">==</span><span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">:</span> <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">or</span> <span class="s">&quot;e&quot;</span> <span class="ow">in</span> <span class="n">l</span> <span class="p">:</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="nb">float</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="nb">int</span>

            <span class="c"># Restart at head of file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">ValueError</span> <span class="p">:</span>
            <span class="c"># this is probably a binary file</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># Read header and check endianness</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;i&quot;</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">l</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">,</span> <span class="s">&quot;Incorrect file format&quot;</span>

            <span class="c"># Set data format to be read (float or int) based on config</span>
            <span class="n">int_arrays</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tipsy&#39;</span><span class="p">,</span> <span class="s">&#39;binary-int-arrays&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="n">int_arrays</span> <span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;i&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;f&#39;</span>

            <span class="c"># Read longest data array possible.  </span>
            <span class="c"># Assume byteswap since most will be.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span><span class="n">fmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">,</span> <span class="s">&quot;Incorrect file format&quot;</span>
            
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ndim</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">,</span> <span class="s">&quot;Incorrect file format&quot;</span>

        <span class="k">if</span> <span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="n">ndim</span><span class="p">)</span>

            <span class="c"># check whether the vector format is specified in the param file</span>
            <span class="c"># this only matters for binary because ascii files use packed vectors by default</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">binary</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">packed_vector</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
                <span class="c"># default bPackedVector = 0, so must use column-major format when reshaping</span>
                <span class="n">v_order</span> <span class="o">=</span> <span class="s">&#39;F&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;bPackedVector&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="p">:</span>
                            <span class="n">v_order</span><span class="o">=</span><span class="s">&quot;C&quot;</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="p">:</span>
                        <span class="k">pass</span>
                    
            <span class="k">elif</span> <span class="p">((</span><span class="n">packed_vector</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">binary</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">packed_vector</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]:</span>
                    <span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;Warning: assuming packed vector format!&#39;</span>
                    <span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;Packed vector means values are in order x1, y1, z1... xn, yn, zn&#39;</span>
                <span class="n">v_order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">v_order</span> <span class="o">=</span> <span class="s">&#39;F&#39;</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">v_order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>

        <span class="k">if</span> <span class="n">fam</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">v_order</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">v_order</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_family_slice</span><span class="p">(</span><span class="n">fam</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="o">.</span><span class="n">_tipsy_arrays_binary</span> <span class="o">=</span> <span class="n">binary</span>

    <span class="k">def</span> <span class="nf">read_starlog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;Read a TIPSY-starlog file.&quot;&quot;&quot;</span>
	
        <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">pynbody.bridge</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">filename</span><span class="o">=</span><span class="bp">None</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c"># Attempt the loading of information</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">&quot;*.starlog&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span> <span class="p">:</span>
                <span class="n">sl</span> <span class="o">=</span> <span class="n">StarLog</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">&quot;../*.starlog&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">IOError</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t find starlog file&quot;</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">sl</span> <span class="o">=</span> <span class="n">StarLog</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="k">print</span> <span class="s">&quot;Bridging starlog into SimSnap&quot;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">OrderBridge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sl</span><span class="p">)</span>
        <span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;iorderGas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;iorderGas&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">)]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;massform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;massform&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">)]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;rhoform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;rhoform&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">)]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;tempform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&#39;tempform&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">)]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)[</span><span class="s">&#39;posform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">),:]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)[</span><span class="s">&#39;velform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="s">&#39;vel&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">),:]</span>
                
	
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_can_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">:</span>
	<span class="c"># to implement!</span>
	<span class="k">return</span> <span class="bp">True</span>

<span class="c"># caculate the number fraction YH, YHe as a function of metalicity. Cosmic </span>
<span class="c"># production rate of helium relative to metals (in mass)  </span>
<span class="c"># delta Y/delta Z = 2.1 and primordial He Yp = 0.236 (Jimenez et al. 2003, </span>
<span class="c"># Science 299, 5612. </span>
<span class="c">#  piecewise linear</span>
<span class="c">#  Y = Yp + dY/dZ*ZMetal up to ZMetal = 0.1, then linear decrease to 0 at Z=1)  </span>

<span class="c">#  SUM_Metal = sum(ni/nH *mi),it is a fixed number for cloudy abundance. </span>
<span class="c">#  Massfraction fmetal = Z*SUM_metal/(1 + 4*nHe/nH + Z*SUM_metal) (1)</span>
<span class="c">#  4*nHe/nH = mHe/mH = fHe/fH </span>
<span class="c">#  also fH + fHe + fMetal = 1  (2)</span>
<span class="c">#  if fHe specified, combining the 2 eq above will solve for </span>
<span class="c">#  fH and fMetal </span>
        
<span class="k">def</span> <span class="nf">_abundance_estimator</span><span class="p">(</span><span class="n">metal</span><span class="p">)</span> <span class="p">:</span>

    <span class="n">Y_He</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.236</span><span class="o">+</span><span class="mf">2.1</span><span class="o">*</span><span class="n">metal</span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">metal</span><span class="o">&lt;=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">Y_He</span><span class="o">+=</span> <span class="p">((</span><span class="o">-</span><span class="mf">0.446</span><span class="o">*</span><span class="p">(</span><span class="n">metal</span><span class="o">-</span><span class="mf">0.1</span><span class="p">)</span><span class="o">/</span><span class="mf">0.9</span><span class="o">+</span><span class="mf">0.446</span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">metal</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">Y_H</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">Y_He</span><span class="o">*</span><span class="mf">4.</span> <span class="o">-</span> <span class="n">metal</span>

    <span class="k">return</span> <span class="n">Y_H</span><span class="p">,</span> <span class="n">Y_He</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">HII</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Number of HII ions per proton mass&quot;&quot;&quot;</span>
<div class="viewcode-block" id="HII"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.HII">[docs]</a>    <span class="n">Y_H</span><span class="p">,</span> <span class="n">Y_He</span> <span class="o">=</span> <span class="n">_abundance_estimator</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;metals&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Y_H</span> <span class="o">-</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;HI&quot;</span><span class="p">]</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">HeIII</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Number of HeIII ions per proton mass&quot;&quot;&quot;</span>
<div class="viewcode-block" id="HeIII"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.HeIII">[docs]</a>    <span class="n">Y_H</span><span class="p">,</span> <span class="n">Y_He</span> <span class="o">=</span> <span class="n">_abundance_estimator</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;metals&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Y_He</span><span class="o">-</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;HeII&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;HeI&quot;</span><span class="p">]</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">ne</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Number of electrons per proton mass&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ne"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.ne">[docs]</a>    <span class="k">return</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;HII&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;HeII&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;HeIII&quot;</span><span class="p">]</span>
    
<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">mu</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Relative atomic mass, i.e. number of particles per</span>
<div class="viewcode-block" id="mu"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.mu">[docs]</a><span class="sd">    proton mass, ignoring metals (since we generally only know the</span>
<span class="sd">    mass fraction of metals, not their specific atomic numbers)&quot;&quot;&quot;</span>
    
    <span class="n">x</span> <span class="o">=</span>  <span class="n">sim</span><span class="p">[</span><span class="s">&quot;HI&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;HII&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;HeI&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;HeII&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;HeIII&quot;</span><span class="p">]</span>
    
    <span class="n">x</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">units</span><span class="o">.</span><span class="n">m_p</span>
    <span class="k">return</span> <span class="n">x</span>
    
<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Specific Internal energy&quot;&quot;&quot;</span>
<div class="viewcode-block" id="u"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.u">[docs]</a>    <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;temp&quot;</span><span class="p">]</span> <span class="c"># per particle</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="o">*</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;mu&quot;</span><span class="p">]</span> <span class="c"># per unit mass</span>
    <span class="n">u</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&quot;eV m_p^-1&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Pressure&quot;&quot;&quot;</span>
<div class="viewcode-block" id="p"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.p">[docs]</a>    <span class="n">p</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;u&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;rho&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&quot;dyn&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">hetot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="k">return</span> <span class="mf">0.236</span><span class="o">+</span><span class="p">(</span><span class="mf">2.1</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;metals&#39;</span><span class="p">])</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="mf">1.0</span><span class="o">-</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;metals&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;hetot&#39;</span><span class="p">]</span>

<span class="c">#from .tipsy import TipsySnap</span>
<span class="c"># Asplund et al (2009) ARA&amp;A solar abundances (Table 1)</span>
<span class="c"># m_frac = 10.0^([X/H] - 12)*M_X/M_H*0.74</span>
<span class="c"># OR</span>
<span class="c"># http://en.wikipedia.org/wiki/Abundance_of_the_chemical_elements      </span>
<span class="c"># puts stuff more straighforwardly cites Arnett (1996)</span>
<span class="c"># A+G from http://www.t4.lanl.gov/opacity/grevand1.html</span>
<span class="c"># Anders + Grev (1989)    Asplund</span>
<span class="n">XSOLFe</span><span class="o">=</span><span class="mf">0.125E-2</span>         <span class="c"># 1.31e-3</span>
<span class="c"># Looks very wrong ([O/Fe] ~ 0.2-0.3 higher than solar), </span>
<span class="c"># probably because SN ejecta are calculated with</span>
<span class="c"># Woosley + Weaver (1995) based on Anders + Grevesse (1989)</span>
<span class="c"># XSOLO=0.59E-2           # 5.8e-2</span>
<span class="n">XSOLO</span><span class="o">=</span><span class="mf">0.84E-2</span>
<span class="n">XSOLH</span><span class="o">=</span><span class="mf">0.706</span>             <span class="c"># 0.74</span>
<span class="n">XSOLC</span><span class="o">=</span><span class="mf">3.03e-3</span>           <span class="c"># 2.39e-3</span>
<span class="n">XSOLN</span><span class="o">=</span><span class="mf">9.2e-4</span>          <span class="c"># 7e-4</span>
<span class="n">XSOLNe</span><span class="o">=</span><span class="mf">1.66e-3</span>          <span class="c"># 1.26e-3</span>
<span class="n">XSOLMg</span><span class="o">=</span><span class="mf">6.44e-4</span>          <span class="c"># 7e-4</span>
<span class="n">XSOLSi</span><span class="o">=</span><span class="mf">7e-4</span>          <span class="c"># 6.7e-4</span>


<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">feh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;hydrogen&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLFe</span><span class="o">/</span><span class="n">XSOLH</span><span class="p">)</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">ofe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">minox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;OxMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;OxMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minox</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;OxMassFrac&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLO</span><span class="o">/</span><span class="n">XSOLFe</span><span class="p">)</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">mgfe</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">minmg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;MgMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;MgMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s">&#39;MgMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;MgMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minmg</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;MgMassFrac&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLMg</span><span class="o">/</span><span class="n">XSOLFe</span><span class="p">)</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">nefe</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">minne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;NeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;NeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s">&#39;NeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;NeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minne</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;NeMassFrac&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLNe</span><span class="o">/</span><span class="n">XSOLFe</span><span class="p">)</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">sife</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">minsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;SiMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;SiMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s">&#39;SiMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;SiMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minsi</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span><span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;SiMassFrac&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">sim</span><span class="p">[</span><span class="s">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLSi</span><span class="o">/</span><span class="n">XSOLFe</span><span class="p">)</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">c_s</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Ideal gas sound speed&quot;&quot;&quot;</span>
<div class="viewcode-block" id="c_s"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.c_s">[docs]</a>    <span class="c">#x = np.sqrt(5./3.*units.k*self[&#39;temp&#39;]*self[&#39;mu&#39;])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">])</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&#39;km s^-1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">c_s_turb</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Turbulent sound speed (from Mac Low &amp; Klessen 2004)&quot;&quot;&quot;</span>
<div class="viewcode-block" id="c_s_turb"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.c_s_turb">[docs]</a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;c_s&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;v_disp&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&#39;km s^-1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">mjeans</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Classical Jeans mass&quot;&quot;&quot;</span>
<div class="viewcode-block" id="mjeans"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.mjeans">[docs]</a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;c_s&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mf">6.</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">G</span><span class="o">**</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&#39;Msol&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">mjeans_turb</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Turbulent Jeans mass&quot;&quot;&quot;</span>
<div class="viewcode-block" id="mjeans_turb"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.mjeans_turb">[docs]</a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;c_s_turb&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mf">6.</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">G</span><span class="o">**</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&#39;Msol&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">ljeans</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Jeans length&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ljeans"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.ljeans">[docs]</a>    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;c_s&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">G</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&#39;kpc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nd">@TipsySnap.derived_quantity</span>
<span class="k">def</span> <span class="nf">ljeans_turb</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
    <span class="sd">&quot;&quot;&quot;Jeans length&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ljeans_turb"><a class="viewcode-back" href="../../pynbody.html#pynbody.tipsy.ljeans_turb">[docs]</a>    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;c_s_turb&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">G</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s">&#39;kpc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">class</span> <span class="nc">StarLog</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">SimSnap</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span></div>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StarLog</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bigstarlog</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;iord&quot;</span><span class="p">,</span><span class="s">&quot;iorderGas&quot;</span><span class="p">,</span><span class="s">&quot;tform&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;massform&quot;</span><span class="p">,</span><span class="s">&quot;rhoform&quot;</span><span class="p">,</span><span class="s">&quot;tempform&quot;</span><span class="p">),</span><span class="s">&#39;formats&#39;</span><span class="p">:(</span><span class="s">&#39;i4&#39;</span><span class="p">,</span><span class="s">&#39;i4&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">)})</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">1000</span> <span class="ow">or</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span>  <span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="o">=</span><span class="bp">True</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">iSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">iSize</span> <span class="o">&gt;</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;iord&quot;</span><span class="p">,</span><span class="s">&quot;iorderGas&quot;</span><span class="p">,</span><span class="s">&quot;tform&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;vx&quot;</span><span class="p">,</span><span class="s">&quot;vy&quot;</span><span class="p">,</span><span class="s">&quot;vz&quot;</span><span class="p">,</span><span class="s">&quot;massform&quot;</span><span class="p">,</span><span class="s">&quot;rhoform&quot;</span><span class="p">,</span><span class="s">&quot;tempform&quot;</span><span class="p">,</span><span class="s">&quot;phiform&quot;</span><span class="p">,</span><span class="s">&quot;nsmooth&quot;</span><span class="p">),</span><span class="s">&#39;formats&#39;</span><span class="p">:(</span><span class="s">&#39;i4&#39;</span><span class="p">,</span><span class="s">&#39;i4&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">,</span><span class="s">&#39;i4&#39;</span><span class="p">)})</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iSize</span> <span class="o">!=</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span> <span class="ow">and</span> <span class="n">iSize</span> <span class="o">!=</span> <span class="mi">104</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;Unknown starlog structure iSize:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iSize</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, file_structure itemsize:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span> <span class="n">bigstarlog</span> <span class="o">=</span> <span class="bp">True</span>
            
        <span class="n">datasize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="k">print</span> <span class="s">&quot;Reading &quot;</span><span class="o">+</span><span class="n">filename</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datasize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datasize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">)</span>

        <span class="c"># hoping to provide backward compatibility for np.unique by</span>
        <span class="c"># copying relavent part of current numpy source:</span>
        <span class="c"># numpy/lib/arraysetops.py:192 (on 22nd March 2011)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s">&#39;iord&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">perm</span><span class="p">]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="bp">True</span><span class="p">],</span><span class="n">aux</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">!=</span><span class="n">aux</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">iord</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="n">flag</span><span class="p">];</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_num_particles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_family_slice</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;pos&quot;</span><span class="p">,</span><span class="s">&quot;vel&quot;</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;iord&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;iorderGas&quot;</span><span class="p">,</span><span class="s">&quot;massform&quot;</span><span class="p">,</span><span class="s">&quot;rhoform&quot;</span><span class="p">,</span><span class="s">&quot;tempform&quot;</span><span class="p">,</span><span class="s">&quot;metals&quot;</span><span class="p">,</span><span class="s">&quot;tform&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bigstarlog</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s">&quot;phiform&quot;</span><span class="p">,</span><span class="s">&quot;nsmooth&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_decorate</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">name</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>

        <span class="c">#self._decorate()</span>


<span class="nd">@TipsySnap.decorator</span>
<span class="nd">@StarLog.decorator</span>
<span class="k">def</span> <span class="nf">load_paramfile</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
    <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filename</span><span class="o">=</span><span class="bp">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">&quot;*.param&quot;</span><span class="p">))</span>

	<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span> <span class="p">:</span>
	    <span class="c"># Attempt the loading of information</span>
	    <span class="k">try</span> <span class="p">:</span>
		<span class="n">f</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
	    <span class="k">except</span> <span class="ne">IOError</span> <span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">&quot;../*.param&quot;</span><span class="p">))</span>
                <span class="k">try</span> <span class="p">:</span> 
                    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">continue</span>
	    
            
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="p">:</span>
		<span class="k">try</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot;#&quot;</span> <span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                                
		<span class="k">except</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span> <span class="p">:</span>
		    <span class="k">pass</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">:</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
                <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
                
        <span class="k">if</span> <span class="n">done</span> <span class="p">:</span> <span class="k">break</span>

            
<span class="nd">@TipsySnap.decorator</span>
<span class="nd">@StarLog.decorator</span>
<span class="k">def</span> <span class="nf">param2units</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">with</span> <span class="n">sim</span><span class="o">.</span><span class="n">lazy_off</span> <span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>

        <span class="n">munit</span> <span class="o">=</span> <span class="n">dunit</span> <span class="o">=</span> <span class="n">hub</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="n">hub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dHubble0&quot;</span><span class="p">])</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;omegaM0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dOmega0&quot;</span><span class="p">])</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;omegaL0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dLambda&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="n">munit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dMsolUnit&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; Msol&quot;</span>
            <span class="n">munit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dMsolUnit&quot;</span><span class="p">])</span>
            <span class="n">dunit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dKpcUnit&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; kpc&quot;</span>
            <span class="n">dunit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dKpcUnit&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">pass</span>


        <span class="k">if</span> <span class="n">munit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">dunit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">hub</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hub</span>
            <span class="k">return</span>


        <span class="n">denunit</span> <span class="o">=</span> <span class="n">munit</span><span class="o">/</span><span class="n">dunit</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">denunit_st</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">denunit</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; Msol kpc^-3&quot;</span>

        <span class="c">#</span>
        <span class="c"># the obvious way:</span>
        <span class="c">#</span>
        <span class="c">#denunit_cgs = denunit * 6.7696e-32</span>
        <span class="c">#kpc_in_km = 3.0857e16</span>
        <span class="c">#secunit = 1./math.sqrt(denunit_cgs*6.67e-8)</span>
        <span class="c">#velunit = dunit*kpc_in_km/secunit</span>

        <span class="c"># the sensible way:</span>
        <span class="c"># avoid numerical accuracy problems by concatinating factors:</span>
        <span class="n">velunit</span> <span class="o">=</span> <span class="mf">8.0285</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.67e-8</span><span class="o">*</span><span class="n">denunit</span><span class="p">)</span> <span class="o">*</span> <span class="n">dunit</span>
        <span class="n">velunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%.5g</span><span class="s">&quot;</span><span class="o">%</span><span class="n">velunit</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; km s^-1&quot;</span>

        <span class="c">#You have: kpc s / km</span>
        <span class="c">#You want: Gyr</span>
        <span class="c">#* 0.97781311</span>
        <span class="n">timeunit</span> <span class="o">=</span> <span class="n">dunit</span> <span class="o">/</span> <span class="n">velunit</span> <span class="o">*</span> <span class="mf">0.97781311</span>
        <span class="n">timeunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%.5g</span><span class="s">&quot;</span><span class="o">%</span><span class="n">timeunit</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; Gyr&quot;</span>

        <span class="c">#  Assuming G=1 in code units, phi is actually vel^2/a^3.</span>
        <span class="c"># See also gasoline&#39;s master.c:5511.</span>
        <span class="c"># Or should we be calculating phi as GM/R units (which</span>
        <span class="c"># is the same for G=1 runs)?</span>
        <span class="n">potunit_st</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%.5g</span><span class="s"> km^2 s^-2&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">velunit</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">hub</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">hubunit</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">velunit</span> <span class="o">/</span> <span class="n">dunit</span>
            <span class="n">hubunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">hubunit</span><span class="o">*</span><span class="n">hub</span><span class="p">))</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hub</span><span class="o">*</span><span class="n">hubunit</span>

            <span class="c"># append dependence on &#39;a&#39; for cosmological runs</span>
            <span class="n">dunit_st</span> <span class="o">+=</span> <span class="s">&quot; a&quot;</span>
            <span class="n">denunit_st</span> <span class="o">+=</span> <span class="s">&quot; a^-3&quot;</span>
            <span class="n">velunit_st</span> <span class="o">+=</span> <span class="s">&quot; a&quot;</span>
            <span class="n">potunit_st</span> <span class="o">+=</span> <span class="s">&quot; a^-1&quot;</span>
        
            <span class="c"># Assume the box size is equal to the length unit</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;boxsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">dunit_st</span><span class="p">)</span>

        <span class="n">sim</span><span class="p">[</span><span class="s">&quot;vel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">velunit_st</span>            
        
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">sim</span><span class="p">[</span><span class="s">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">potunit_st</span>
            <span class="n">sim</span><span class="p">[</span><span class="s">&quot;eps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">dunit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">sim</span><span class="p">[</span><span class="s">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">dunit_st</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="p">[</span><span class="s">&quot;rho&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">denunit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="n">sim</span><span class="p">[</span><span class="s">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">munit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&quot;tform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">timeunit_st</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="p">[</span><span class="s">&quot;metals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&quot;metals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">_file_units_system</span> <span class="o">=</span> <span class="p">[</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;vel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">_file_units_system</span> <span class="o">=</span> <span class="p">[</span><span class="n">sim</span><span class="p">[</span><span class="s">&quot;vel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&quot;massform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="p">[</span><span class="s">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">:</span> <span class="k">pass</span>


<span class="nd">@StarLog.decorator</span>
<span class="k">def</span> <span class="nf">slparam2units</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">with</span> <span class="n">sim</span><span class="o">.</span><span class="n">lazy_off</span> <span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>

        <span class="n">munit</span> <span class="o">=</span> <span class="n">dunit</span> <span class="o">=</span> <span class="n">hub</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="n">munit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dMsolUnit&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; Msol&quot;</span>
            <span class="n">munit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dMsolUnit&quot;</span><span class="p">])</span>
            <span class="n">dunit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dKpcUnit&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; kpc&quot;</span>
            <span class="n">dunit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dKpcUnit&quot;</span><span class="p">])</span>
            <span class="n">hub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s">&quot;dHubble0&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">munit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">dunit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="k">return</span>

        <span class="n">denunit</span> <span class="o">=</span> <span class="n">munit</span><span class="o">/</span><span class="n">dunit</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">denunit_st</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">denunit</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; Msol kpc^-3&quot;</span>

        <span class="k">if</span> <span class="n">hub</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
            <span class="c"># append dependence on &#39;a&#39; for cosmological runs</span>
            <span class="n">dunit_st</span> <span class="o">+=</span> <span class="s">&quot; a&quot;</span>
            <span class="n">denunit_st</span> <span class="o">+=</span> <span class="s">&quot; a^-3&quot;</span>
            
        <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&quot;rhoform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">denunit_st</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s">&quot;massform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">munit_st</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pynbody v0.13-alpha documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pynbody.html" >pynbody</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, pynbody team (http://code.google.com/p/pynbody/people/list).
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.8.
    </div>
  </body>
</html>